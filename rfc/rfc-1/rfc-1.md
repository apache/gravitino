# RFC-1: Metadata Spec Design

| Revision | Owner      |
| :------- | ---------- |
| v0.1     | Jerry Shao |

## Design Prerequisites

1. The metadata spec should be evolved, backward compatible, and possibly forward compatible (If possible and necessary).
2. The on-wire protocol (user-faced interface) should be readable and debuggable by mainstream web-based tools.
3. The storage layout should be concise and performant, also be backward compatible.
4. The type and schema system should be generic enough to cover mainstream db/dws/dl’s schema system.
5. The schema can be evolved to support non-table datasets (stream, model).
6. The schema should be evolved to support Hive’s schema spec, so we could replace HMS later on.

## Design choices

1. We choose to leverage Substrait’s type system into our entities’ type system. The main considerations are here:
    1. The goal of Substrait is to build a generic intermediate layer, its type system is relatively complete.
    2. We will further use Substrait to represent our logical plans (for example, like view, function and others), so using Substrait’s type system will reduce some converting works later on.
2. We choose JSON protocol as our user-faced protocol, which is easy to debug for users and systems.
3. We choose Protobuf binary layout to store the schema, the main considerations are here:
    1. Binary layout is much more concise compared to HMS’s schema layout.
    2. A general-purpose NoSQL database can be used to store the schema, which will get better performance and scalability compared to Hive Metastore.

## Type System

We use Substrait’s type system to define our schema’s type, the advantages of using Substrait’s type system is that:

1. Substrait’s type system is generic enough to cover major type kinds of DWS, DBS, and other type system.
2. Substrait supports extending the type systems to user-defined types.
3. Substrait support serializing and deserializing using Google protobuf.

Disadvantages:

1. Substrait is still in fast iteration, the spec is not fully defined yet, also the project is not mature enough. So we potentially have the risk of breaking backward compatibility.
2. Also Substrait lacks best practices, the learning curve is relatively high.

Substrait’s type system can be referred here https://substrait.io/types/type_system/.

## Schema System

### Prerequisites

1. The field name of schema should use lowercase with "_" connecting different words, the name convention is `^[a-z](?:_?[a-z0-9]+)*$`.
1. The schema system uses Google Protobuf to describe the structs.

### Schema Entities

#### SchemaVersion

| Field Name    | Field Type | Description                                                  | Optional |
| ------------- | ---------- | ------------------------------------------------------------ | -------- |
| major_version | uint32     | The major version of the schema system. Backward compatibility is guaranteed within the major version and is best-effort guaranteed between versions. | Required |
| minor_version | uint32     | The minor version of the schema system. Backward compatibility is guaranteed between versions | Required |

#### AuditInfo

| Field Name       | Field Type | Description                                                  | Optional |
| ---------------- | ---------- | ------------------------------------------------------------ | -------- |
| creator          | string     | The name of user who creates the schema entity               | Required |
| create_time      | timestamp  | Google Protobuf timestamp type to represent when entity is created | Required |
| last_modifier    | string     | The name of user who modified the schema entity last time    | Optional |
| last_modify_time | timestamp  | Google Protobuf timestamp type to represent when entity is modified | Optional |
| last_accessor    | string     | The name of user who acecess the schema entity last time     | Optional |
| last_access_time | timestamp  | Google Protobuf timestamp type to represent when entity is accessed | Optional |

#### Tenant

| Field Name | Field Type    | Description                                                  | Optional |
| ---------- | ------------- | ------------------------------------------------------------ | -------- |
| id         | uint32        | The unique id to represent this tenant, this is generated by the system and used as unique identification of the tenant | Required |
| name       | string        | Tenant name specified by creator                             | Required |
| comment    | string        | The detailed comment of this tenant                          | Optional |
| audit_info | AuditInfo     | The detailed audit info of tenant                            | Required |
| version    | SchemaVersion | The version info of tenant                                   | Required |

#### Lakehouse

| Field Name | Field Type          | Description                                                  | Optional |
| ---------- | ------------------- | ------------------------------------------------------------ | -------- |
| id         | uint64              | The unique id to repesent this lakehouse, this is generated by the system and used as the unique identification of the lakehouse | Required |
| name       | string              | Lakehouse name specified by creator                          | Required |
| comment    | string              | The detailed comment of this catalog                         | Optional |
| properties | map<string, string> | The custom properties of lakehouse                           | Optional |
| audit_info | AuditInfo           | The detailed audit info of lakehouse                         | Required |

#### Zone

| Field Name   | Field Type          | Description                                                  | Optional |
| ------------ | ------------------- | ------------------------------------------------------------ | -------- |
| id           | uint64              | The unique id to represent this zone, this is generated by the system and used as the unique identification of the zone | Required |
| lakehouse_id | uint64              | The id of lakehouse which includes this zone                 | Required |
| name         | string              | Zone name specified by creator                               | Required |
| comment      | string              | The detailed comment of this Zone                            | Required |
| properties   | map<string, string> | Properties in kv pair of this Zone                           | Optional |
| audit_info   | AuditInfo           | The detailed audit info of lakehouse                         | Required |

#### Entity

##### Column

| Field Name         | Field Type     | Description                                       | Optional |
| ------------------ | -------------- | ------------------------------------------------- | -------- |
| id                 | uint32         | The unique id to represent this column            | Required |
| parent_entity_id   | uint64         | The id parent entity to which this column belongs | Required |
| parent_snapshot_id | uint64         | The snapshot id of parent entity                  | Required |
| name               | string         | Column name specified by creator                  | Required |
| type               | Substrait Type | Column type specified by creator                  | Required |
| comment            | string         | The detailed comment of this column               | Optional |
| pos                | uint32         | Position of the column                            | Required |

Note. The `type` field serialization and deserialization need to follow Substrait's way.

##### Table

**TableType - VirtualTable**

| Field Name          | Field Type      | Description                                                  | Optional |
| ------------------- | --------------- | ------------------------------------------------------------ | -------- |
| connection_id (TBD) | uint32          | The unique id to represent the connector which used to get physical table | Required |
| physical_identifier | repeated string | The identifier to specify the physical table                 | Required |

**TableType - ViewTable**

**TableType - ExternalTable**

**TableType - ManagedTable**


| Field Name    | Field Type          | Description                                     | Optional |
| ------------- | ------------------- | ----------------------------------------------- | -------- |
| id            | uint64              | The unique to represent this table              | Required |
| zone_id       | uint64              | The id of zone which includes this table        | Required |
| name          | string              | Table name specified by creator                 | Required |
| type          | TableType           | The type of table                               | Required |
| snapshot_id   | uint64              | current snapshot of this table                  | Required |
| properties    | map<string, string> | Properties in kv pair of this Table             | Optional |
| audit_info    | AuditInfo           | The detailed audit info of Table                | Required |
| virtual_table | oneof TableType     | Specific table info corresponding to table type | Required |
